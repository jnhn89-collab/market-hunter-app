<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hunter Pro</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; background-color: #000; 
            font-family: -apple-system, BlinkMacSystemFont, "Pretendard", Roboto, sans-serif;
            color: white; height: 100vh; overflow: hidden; 
            display: flex; justify-content: center; align-items: center; 
        }
        
        .app-frame { 
            width: 100%; max-width: 420px; height: 100%; max-height: 900px; 
            background-color: #121212; position: relative; 
            display: flex; flex-direction: column; overflow: hidden; 
            border: 1px solid #333; 
        }
        @media (min-width: 480px) { 
            .app-frame { border-radius: 30px; height: 90vh; box-shadow: 0 0 50px rgba(255,255,255,0.1); } 
        }

        /* í™”ë©´ ì „í™˜ */
        .view-section { display: none; flex-direction: column; height: 100%; width: 100%; position: absolute; top:0; left:0; background: #121212; z-index: 1;}
        .view-section.active { display: flex; z-index: 10; }

        /* í™ˆ í™”ë©´ */
        .home-container { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 30px; overflow-y: auto;}
        .app-title { 
            font-size: 40px; font-weight: 900; text-align: center; margin-bottom: 5px; 
            background: linear-gradient(to right, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            cursor: pointer; user-select: none; /* í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½ */
        }
        .limit-info { text-align: center; font-size: 13px; color: #666; margin-bottom: 30px; }

        .mode-card { 
            background: #1e1e1e; border: 1px solid #333; border-radius: 20px; 
            padding: 25px; margin-bottom: 15px; cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; justify-content: space-between;
        }
        .mode-card:active { transform: scale(0.98); background: #252525; }
        .mode-card.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        .mode-icon { font-size: 32px; margin-right: 15px; }
        .mode-text h3 { margin: 0; font-size: 20px; }
        .mode-text p { margin: 5px 0 0 0; font-size: 13px; color: #888; }
        
        .stamina { font-size: 12px; font-weight: bold; color: #00ff88; background: rgba(0, 255, 136, 0.1); padding: 4px 8px; border-radius: 10px; }
        .stamina.empty { color: #ff5f5f; background: rgba(255, 95, 95, 0.1); }

        /* í€´ì¦ˆ í™”ë©´ */
        .top-bar { height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #222; background: #121212; z-index: 20; flex-shrink: 0;}
        .progress-bar { width: 100%; height: 4px; background: #222; flex-shrink: 0;}
        .progress-fill { height: 100%; background: #00ff88; width: 0%; transition: width 0.3s; }

        .card-area { flex: 1; position: relative; padding: 15px; display: flex; flex-direction: column; overflow: hidden; }
        .card { 
            flex: 1; background: #1e1e1e; border-radius: 20px; padding: 20px; 
            display: flex; flex-direction: column; 
            border: 1px solid #333; overflow: hidden; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ì„ ìœ„í•´ hidden */
        }
        
        .card-header-area { flex-shrink: 0; margin-bottom: 10px; }
        .chart-img { width: 100%; height: auto; max-height: 180px; object-fit: contain; background: #000; border-radius: 10px; margin-bottom: 15px; border: 1px solid #444; }
        .tag { display: inline-block; background: #333; color: #aaa; padding: 4px 8px; border-radius: 6px; font-size: 11px; margin-bottom: 10px; font-weight: bold; }
        .card-title { font-size: 22px; font-weight: 800; margin-bottom: 10px; line-height: 1.3; }
        .summary { font-size: 15px; color: #ff5f5f; font-weight: 700; margin-bottom: 10px; }
        
        .card-body-area { flex-grow: 1; overflow-y: auto; padding-right: 5px; margin-bottom: 10px; }
        .card-desc { font-size: 15px; line-height: 1.6; color: #ddd; white-space: pre-line; }
        
        .card-footer-area { flex-shrink: 0; }
        .quiz-section { padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid #444; }
        .quiz-q { font-size: 16px; font-weight: bold; color: #fff; margin: 0; line-height: 1.4; }

        .bottom-bar { padding: 15px; background: #121212; border-top: 1px solid #222; z-index: 20; flex-shrink: 0;}
        .btn-group { display: flex; gap: 10px; height: 50px; }
        .btn-ox { flex: 1; border: none; border-radius: 12px; font-size: 20px; font-weight: 900; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .btn-x { background: #2a2a2a; color: #ff5f5f; border: 2px solid #ff5f5f; }
        .btn-o { background: #2a2a2a; color: #4caf50; border: 2px solid #4caf50; }
        .btn-next { background: #fff; color: #000; font-size: 16px; width: 100%; display: none; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; }

        /* íˆìŠ¤í† ë¦¬ & ì„œë¨¸ë¦¬ */
        .history-list { flex: 1; overflow-y: auto; padding: 20px; }
        .date-header { font-size: 12px; color: #666; margin: 15px 0 5px 0; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .hist-item { background: #1e1e1e; padding: 15px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #222; }
        .hist-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-weight: bold; }
        .tag-rocket { background: rgba(255, 75, 75, 0.2); color: #ff4b4b; }
        .tag-seed { background: rgba(0, 255, 136, 0.2); color: #00ff88; }

        .summary-box { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .summary-ticker { font-size: 40px; font-weight: 900; color: #00ff88; margin: 20px 0; }
        .btn-restart { width: 80%; padding: 15px; background: #333; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* ìœ í‹¸ë¦¬í‹° */
        .overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:none; flex-direction:column; justify-content:center; align-items:center; z-index: 100; padding: 30px; text-align: center; }
        .wiki-word { color: #86efac; border-bottom: 1px dashed rgba(134,239,172,0.5); cursor: pointer; }
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:999; display:none; justify-content:center; align-items:center; }
        .modal img { max-width:100%; max-height:100%; }
        .wiki-modal { position: absolute; bottom: 0; left: 0; width: 100%; background: #222; border-top: 2px solid #00ff88; border-radius: 25px 25px 0 0; padding: 30px; z-index: 200; transform: translateY(100%); transition: transform 0.3s; box-shadow: 0 -10px 50px rgba(0,0,0,0.8); }
        .wiki-modal.show { transform: translateY(0); }
        
        .loader-box { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #00ff88; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .slide-out { transform: translateX(120%) rotate(10deg); opacity: 0; transition: 0.3s; }
    </style>
</head>
<body>

<div class="app-frame">

    <div id="view-home" class="view-section active">
        <div class="home-container">
            <div class="app-title" onclick="resetCount()">MARKET<br>HUNTER</div>
            <div class="limit-info" id="today-date">0000.00.00</div>

            <div class="mode-card" id="card-rocket" onclick="runAnalysis('ROCKET')">
                <div style="display:flex; align-items:center;">
                    <div class="mode-icon">ğŸš€</div>
                    <div class="mode-text"><h3>ROCKET</h3><p>ê¸‰ë“±ì£¼ / ì£¼ë„ì£¼</p></div>
                </div>
                <div class="stamina" id="stamina-rocket">3/3</div>
            </div>

            <div class="mode-card" id="card-seed" onclick="runAnalysis('SEED')">
                <div style="display:flex; align-items:center;">
                    <div class="mode-icon">ğŸŒ±</div>
                    <div class="mode-text"><h3>SEED</h3><p>ìœ ë§ì£¼ / ë°”ë‹¥ê¶Œ</p></div>
                </div>
                <div class="stamina" id="stamina-seed">3/3</div>
            </div>

            <div class="mode-card" onclick="showHistory()" style="margin-top:20px; background:none; border:1px dashed #444; justify-content:center;">
                <div style="display:flex; align-items:center;">
                    <div class="mode-icon" style="font-size:24px;">ğŸ“‚</div>
                    <div class="mode-text"><h3>History Archive</h3></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-loading" class="view-section">
        <div class="loader-box">
            <div class="spinner"></div>
            <h3>ì‹œì¥ ë¶„ì„ ì¤‘...</h3>
            <p style="color:#666;">AIê°€ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <div id="view-quiz" class="view-section">
        <div class="top-bar">
            <div style="cursor:pointer;" onclick="goHome()">ğŸ  í™ˆ</div>
            <div style="font-weight:bold;" id="page-idx">1 / 5</div>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
        
        <div class="card-area" id="card-wrapper">
            </div>

        <div class="bottom-bar">
            <div class="btn-group">
                <button class="btn-ox btn-x" onclick="check('X')">X</button>
                <button class="btn-ox btn-o" onclick="check('O')">O</button>
                <button class="btn-next" id="btn-next" onclick="nextCard()">ë‹¤ìŒ ğŸ‘‰</button>
            </div>
        </div>
    </div>

    <div id="view-summary" class="view-section">
        <div class="summary-box">
            <div style="font-size:60px;">ğŸ”¥</div>
            <h2>ë¶„ì„ ì™„ë£Œ</h2>
            <div class="summary-ticker" id="res-ticker">TICKER</div>
            <p style="color:#888;">ì˜¤ëŠ˜ì˜ í•™ìŠµì´ ëë‚¬ìŠµë‹ˆë‹¤.</p>
            <div style="width:100%; margin-top:30px;">
                <button class="btn-restart" onclick="goHome()">ë©”ì¸ìœ¼ë¡œ</button>
                <button class="btn-restart" style="background:#222; margin-top:10px; color:#888;" onclick="location.reload()">ë‹¤ì‹œ ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <div id="view-history" class="view-section">
        <div class="top-bar">
            <span onclick="goHome()" style="cursor:pointer;">â† ë’¤ë¡œê°€ê¸°</span>
            <span style="font-weight:bold;">History</span>
        </div>
        <div class="history-list" id="history-list"></div>
    </div>

    <div id="overlay" class="overlay">
        <div style="font-size:60px; margin-bottom:20px;" id="fb-icon"></div>
        <div style="font-size:24px; font-weight:bold; margin-bottom:15px;" id="fb-title"></div>
        <div style="font-size:16px; color:#ccc; line-height:1.6;" id="fb-cmt"></div>
        <button class="btn-next" style="display:block; margin-top:30px; width:80%;" onclick="closeOverlay()">í™•ì¸</button>
    </div>
    <div class="modal" id="chart-modal" onclick="this.style.display='none'"><img id="modal-img"></div>
    <div class="wiki-modal" id="wiki-modal">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <div id="wiki-title" style="color:#00ff88; font-weight:bold; font-size:22px;"></div>
            <div onclick="document.getElementById('wiki-modal').classList.remove('show')" style="cursor:pointer; font-size:24px;">âœ•</div>
        </div>
        <div id="wiki-content" style="font-size:16px; line-height:1.6; color:#ddd;"></div>
    </div>

</div>

<script>
    const MAX_DAILY = 3;
    let cardsData = [], dictionary = {}, currentIndex = 0;
    let resetClickCount = 0; // ë¦¬ì…‹ìš© í´ë¦­ ì¹´ìš´í„°

    initApp();

    async function initApp() {
        document.getElementById('today-date').innerText = new Date().toLocaleDateString();
        updateStaminaUI();
        try {
            const res = await fetch('database.json');
            const data = await res.json();
            data.forEach(item => dictionary[item.title] = item.description);
        } catch(e){}
    }

    // [ë¹„ë°€ ê¸°ëŠ¥] ì œëª© 3ë²ˆ í´ë¦­ì‹œ ë¦¬ì…‹
    function resetCount() {
        resetClickCount++;
        if(resetClickCount >= 3) {
            const todayKey = new Date().toISOString().slice(0, 10);
            localStorage.removeItem('usage_' + todayKey);
            alert("ì‚¬ìš© íšŸìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
            updateStaminaUI();
            resetClickCount = 0;
        }
    }

    function updateStaminaUI() {
        const todayKey = new Date().toISOString().slice(0, 10);
        const usage = JSON.parse(localStorage.getItem('usage_' + todayKey) || '{"ROCKET":0, "SEED":0}');
        
        ['ROCKET', 'SEED'].forEach(m => {
            const left = MAX_DAILY - usage[m];
            const el = document.getElementById('stamina-' + m.toLowerCase());
            const card = document.getElementById('card-' + m.toLowerCase());
            
            el.innerText = `${left}/${MAX_DAILY}`;
            if (left <= 0) {
                el.classList.add('empty');
                card.classList.add('disabled');
            } else {
                el.classList.remove('empty');
                card.classList.remove('disabled');
            }
        });
    }

    async function runAnalysis(mode) {
        const todayKey = new Date().toISOString().slice(0, 10);
        const usage = JSON.parse(localStorage.getItem('usage_' + todayKey) || '{"ROCKET":0, "SEED":0}');
        if (usage[mode] >= MAX_DAILY) return alert("ì˜¤ëŠ˜ íšŸìˆ˜ ì´ˆê³¼!");

        showView('view-loading');

        try {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ mode: mode })
            });
            
            if (!res.ok) throw new Error("ì„œë²„ ì—ëŸ¬");
            const data = await res.json();
            if (data.error) throw new Error(data.error);

            cardsData = data.cards.map((c, i) => ({ ...c, id: i }));
            currentIndex = 0;

            usage[mode]++;
            localStorage.setItem('usage_' + todayKey, JSON.stringify(usage));
            updateStaminaUI();

            renderCard();
            showView('view-quiz');

        } catch (e) {
            alert("ì˜¤ë¥˜: " + e.message);
            goHome();
        }
    }

    function renderCard() {
        const wrapper = document.getElementById('card-wrapper');
        wrapper.innerHTML = '';
        
        if (currentIndex >= cardsData.length) {
            showSummary();
            return;
        }

        document.getElementById('page-idx').innerText = `${currentIndex + 1} / ${cardsData.length}`;
        document.querySelector('.progress-fill').style.width = `${((currentIndex)/cardsData.length)*100}%`;

        const data = cardsData[currentIndex];
        
        let imgHtml = '';
        if (data.image) {
            imgHtml = `<img src="${data.image}" class="chart-img" onclick="expandChart(this.src)">`;
        }

        const linkedDesc = autoLink(data.description);
        const linkedQuiz = autoLink(data.quiz);

        const isProfile = data.type === 'PROFILE';
        const btnX = document.querySelector('.btn-x');
        const btnO = document.querySelector('.btn-o');
        const btnNext = document.getElementById('btn-next');

        if (isProfile) {
            btnX.style.display = 'none';
            btnO.style.display = 'none';
            btnNext.style.display = 'block';
            btnNext.innerText = "ë¶„ì„ ì‹œì‘ ğŸ‘‰";
        } else {
            btnX.style.display = 'block';
            btnO.style.display = 'block';
            btnNext.style.display = 'none';
            btnNext.innerText = "ë‹¤ìŒ ğŸ‘‰";
        }

        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
            <div class="card-header-area">
                <div class="tag">${data.tag}</div>
                <div class="card-title">${data.title}</div>
                ${imgHtml}
                <div class="summary">${data.summary}</div>
            </div>
            <div class="card-body-area">
                <div class="card-desc">${linkedDesc}</div>
            </div>
            <div class="card-footer-area">
                ${!isProfile ? `<div class="quiz-section"><div class="quiz-q">Q. ${linkedQuiz}</div></div>` : ''}
            </div>
        `;
        
        if (isProfile && data.website) {
            el.querySelector('.card-footer-area').innerHTML += `<div style="text-align:center; margin-top:10px;"><a href="${data.website}" target="_blank" style="color:#666; font-size:12px;">ğŸŒ ê³µì‹ í™ˆí˜ì´ì§€</a></div>`;
        }

        wrapper.appendChild(el);
        document.getElementById('overlay').style.display = 'none';
    }

    function check(choice) {
        const data = cardsData[currentIndex];
        const isCorrect = (choice === data.answer.trim().substring(0,1).toUpperCase());
        
        document.getElementById('fb-icon').innerText = isCorrect ? "ğŸ‰" : "ğŸ˜…";
        document.getElementById('fb-title').innerText = isCorrect ? "ì •ë‹µ!" : "ì˜¤ë‹µ";
        document.getElementById('fb-title').style.color = isCorrect ? "#4caf50" : "#ff5f5f";
        document.getElementById('fb-cmt').innerText = data.comment;
        
        document.getElementById('overlay').style.display = 'flex';
        
        document.querySelector('.btn-x').style.display = 'none';
        document.querySelector('.btn-o').style.display = 'none';
        document.getElementById('btn-next').style.display = 'block';
        document.getElementById('btn-next').innerText = "ë‹¤ìŒ ğŸ‘‰";
    }

    function closeOverlay() {
        document.getElementById('overlay').style.display = 'none';
        nextCard();
    }

    function nextCard() {
        currentIndex++;
        renderCard();
    }

    function showSummary() {
        document.getElementById('res-ticker').innerText = cardsData[0].title;
        showView('view-summary');
    }

    async function showHistory() {
        showView('view-loading');
        try {
            const res = await fetch('history.json');
            const history = await res.json();
            
            const list = document.getElementById('history-list');
            list.innerHTML = '';

            const grouped = {};
            history.forEach(h => {
                if (!grouped[h.date]) grouped[h.date] = [];
                grouped[h.date].push(h);
            });

            Object.keys(grouped).sort().reverse().forEach(date => {
                const header = document.createElement('div');
                header.className = 'date-header';
                header.innerText = date;
                list.appendChild(header);

                grouped[date].forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'hist-item';
                    const modeTag = item.mode === 'ROCKET' ? 
                        `<span class="hist-tag tag-rocket">ROCKET</span>` : 
                        `<span class="hist-tag tag-seed">SEED</span>`;
                    
                    el.innerHTML = `
                        <div>
                            <div style="font-weight:bold; color:white; font-size:16px;">${item.ticker}</div>
                            <div style="font-size:12px; color:#888;">${item.company_name}</div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            ${modeTag}
                            <span style="font-size:18px; color:#666;">â€º</span>
                        </div>
                    `;
                    el.onclick = () => {
                        cardsData = item.cards.map((c, i) => ({ ...c, id: i }));
                        currentIndex = 0;
                        renderCard();
                        showView('view-quiz');
                    };
                    list.appendChild(el);
                });
            });
            showView('view-history');
        } catch(e) {
            alert("íˆìŠ¤í† ë¦¬ ì—†ìŒ");
            goHome();
        }
    }

    function showView(id) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function goHome() { showView('view-home'); updateStaminaUI(); }
    
   function autoLink(text) {
        if (!text) return "";
        
        // 1. ì‚¬ì „ í‚¤ì›Œë“œ ì¤€ë¹„ (ê¸´ ë‹¨ì–´ë¶€í„°)
        const keys = Object.keys(dictionary).sort((a,b) => b.length - a.length);
        if (keys.length === 0) return text;

        // 2. í‚¤ì›Œë“œ ì´ìŠ¤ì¼€ì´í”„ (ì •ê·œì‹ íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬)
        const escapedKeys = keys.map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
        
        // 3. [í•µì‹¬] HTML íƒœê·¸ëŠ” ê±´ë„ˆë›°ê³ , í…ìŠ¤íŠ¸ ë…¸ë“œë§Œ ì°¾ì•„ì„œ ë°”ê¾¸ëŠ” ì •ê·œì‹
        // ì„¤ëª…: (>|^)ëŠ” íƒœê·¸ê°€ ëë‚œ ì§í›„ë‚˜ ë¬¸ì¥ ì‹œì‘ì„ ì˜ë¯¸
        // ([^<]*)ëŠ” íƒœê·¸ê°€ ì‹œì‘ë˜ê¸° ì „ê¹Œì§€ì˜ ìˆœìˆ˜ í…ìŠ¤íŠ¸
        // ì´ ì•ˆì—ì„œë§Œ ë‹¨ì–´ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        const regex = new RegExp(`(>|^)([^<]*)(${escapedKeys.join('|')})`, 'gi');

        // 4. ë³€í™˜ ì‹¤í–‰ (ì¬ê·€ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ)
        // ì´ë¯¸ ë§í¬ê°€ ê±¸ë¦° ë‹¨ì–´ëŠ” ë‹¤ì‹œ ê±´ë“œë¦¬ì§€ ì•Šë„ë¡ 'í•œ ë²ˆë§Œ' ì‹¤í–‰í•˜ê±°ë‚˜
        // DOM íŒŒì‹± ë°©ì‹ì„ ì“°ëŠ” ê²Œ ê°€ì¥ ì•ˆì „í•˜ì§€ë§Œ, ì—¬ê¸°ì„  ì •ê·œì‹ìœ¼ë¡œ íƒœê·¸ ë°– í…ìŠ¤íŠ¸ë§Œ íƒ€ê²ŸíŒ…
        
        // ê°„ë‹¨í•˜ë©´ì„œ ê°•ë ¥í•œ ë°©ë²•: ì„ì‹œ DOMì„ ë§Œë“¤ì–´ì„œ í…ìŠ¤íŠ¸ ë…¸ë“œë§Œ êµì²´
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = text;
        
        replaceTextNodes(tempDiv, keys);
        
        return tempDiv.innerHTML;
    }

    // í…ìŠ¤íŠ¸ ë…¸ë“œë§Œ ê³¨ë¼ì„œ ë§í¬ë¥¼ ê±°ëŠ” ì•ˆì „í•œ í•¨ìˆ˜
    function replaceTextNodes(node, keywords) {
        if (node.nodeType === 3) { // í…ìŠ¤íŠ¸ ë…¸ë“œë¼ë©´
            let text = node.nodeValue;
            let replaced = false;
            
            // í‚¤ì›Œë“œ ì°¾ê¸°
            for (let key of keywords) {
                if (text.includes(key)) {
                    // ì´ë¯¸ ë§í¬ëœ ë‹¨ì–´ì¸ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
                    // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí•˜ê²Œ ì²« ë²ˆì§¸ ë°œê²¬ëœ ê²ƒë§Œ ë°”ê¿ˆ
                    const span = document.createElement('span');
                    span.className = 'wiki-word';
                    span.innerText = key;
                    span.setAttribute('onclick', `showWiki('${key}', event)`);
                    
                    const parts = text.split(key);
                    const fragment = document.createDocumentFragment();
                    
                    fragment.appendChild(document.createTextNode(parts[0]));
                    fragment.appendChild(span);
                    fragment.appendChild(document.createTextNode(parts.slice(1).join(key)));
                    
                    node.parentNode.replaceChild(fragment, node);
                    replaced = true;
                    break; // í•œ ë…¸ë“œì— í•˜ë‚˜ë§Œ ë§í¬ (ì¶©ëŒ ë°©ì§€)
                }
            }
        } else if (node.nodeType === 1 && node.tagName !== 'SPAN' && node.tagName !== 'A') {
            // ìš”ì†Œ ë…¸ë“œë¼ë©´ (ë‹¨, ì´ë¯¸ ë§í¬ì¸ spanì´ë‚˜ aëŠ” ì œì™¸) ìì‹ë“¤ì„ íƒìƒ‰
            // childNodesë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•´ì„œ ìˆœíšŒ (ì‹¤ì‹œê°„ ë³€ê²½ ë°©ì§€)
            Array.from(node.childNodes).forEach(child => replaceTextNodes(child, keywords));
        }
    }

    function showWiki(word, e) {
        e.stopPropagation();
        document.getElementById('wiki-title').innerText = word;
        document.getElementById('wiki-content').innerText = dictionary[word] || "ë‚´ìš© ì—†ìŒ";
        document.getElementById('wiki-modal').classList.add('show');
    }
    
    function expandChart(src) {
        document.getElementById('chart-modal').style.display = 'flex';
        document.getElementById('modal-img').src = src;
    }
</script>
</body>
</html>